{% extends 'core/base.html' %}
{% block content %}
<!-- ***** Prevents Notes Box From Being Re-Sizeable ***** -->
<style>
       #{{ form.notes.id_for_label }} {
        resize: none;
    }
</style>

    <div class="container-add-edit">
        <h2 class="page-title">{% if form.instance.pk %}Edit Sale{% else %}Add New Sale{% endif %}</h2>
        <div class="table-responsive">
            <form method="post" id="saleForm">
                {% csrf_token %}
                <table class="table sale-form-table">
                    <tbody>
                        <tr class="job_num">
                            <th scope="row"><label for="{{ form.job_number.id_for_label }}" class="form-job-number">Job Number</label></th>
                            <td>
                                <input type="text" name="{{ form.job_number.name }}" id="{{ form.job_number.id_for_label }}" class="form-control" placeholder="Enter job number" value="{{ form.job_number.value|default_if_none:'' }}">
                                {% if form.job_number.errors %}
                                    <div class="text-danger">{{ form.job_number.errors }}</div>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="{{ form.name.id_for_label }}" class="form-label-add-edit">Customer Name</label></th>
                            <td>
                                <input type="text" name="{{ form.name.name }}" id="{{ form.name.id_for_label }}" class="form-control" placeholder="Enter customer name" value="{{ form.name.value|default_if_none:'' }}">
                                {% if form.name.errors %}
                                    <div class="text-danger">{{ form.name.errors }}</div>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="{{ form.address.id_for_label }}" class="form-label-add-edit">Customer Address</label></th>
                            <td>
                                <input type="text" name="{{ form.address.name }}" id="{{ form.address.id_for_label }}" class="form-control" placeholder="Enter customer address" value="{{ form.address.value|default_if_none:'' }}">
                                <input type="hidden" name="{{ form.latitude.name }}" id="{{ form.latitude.id_for_label }}" class="d-none" value="{{ form.latitude.value|default_if_none:'' }}">
                                <input type="hidden" name="{{ form.longitude.name }}" id="{{ form.longitude.id_for_label }}" class="d-none" value="{{ form.longitude.value|default_if_none:'' }}">
                                <small class="form-text text-muted">Start typing to search for an address</small>
                                <div id="autocomplete-error" class="text-danger" style="display: none;">Address autocomplete failed to load. Please enter the address manually.</div>
                                {% if form.address.errors %}
                                    <div class="text-danger">{{ form.address.errors }}</div>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="{{ form.sale_date.id_for_label }}" class="form-label-add-edit">Sale Date</label></th>
                            <td>
                                <input type="date" name="{{ form.sale_date.name }}" id="{{ form.sale_date.id_for_label }}" class="form-control" placeholder="YYYY-MM-DD" value="{% if form.sale_date.value %}{{ form.sale_date.value|date:'Y-m-d' }}{% endif %}">
                                {% if form.sale_date.errors %}
                                    <div class="text-danger">{{ form.sale_date.errors }}</div>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="{{ form.amount.id_for_label }}" class="form-label-add-edit">Sale Amount ($)</label></th>
                            <td>
                                <input type="number" name="{{ form.amount.name }}" id="{{ form.amount.id_for_label }}" class="form-control" placeholder="Enter sale amount" value="{{ form.amount.value|default_if_none:'' }}">
                                {% if form.amount.errors %}
                                    <div class="text-danger">{{ form.amount.errors }}</div>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="{{ form.sale_amount_split.id_for_label }}" class="form-label-add-edit">Reps Responsible</label></th>
                            <td>
                                {{ form.sale_amount_split }}
                                {% if form.sale_amount_split.errors %}
                                    <div class="text-danger">{{ form.sale_amount_split.errors }}</div>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="{{ form.commission.id_for_label }}" class="form-label-add-edit">Commission ($)</label></th>
                            <td>
                                <input type="number" name="{{ form.commission.name }}" id="{{ form.commission.id_for_label }}" class="form-control" placeholder="Enter commission" value="{{ form.commission.value|default_if_none:'' }}">
                                {% if form.commission.errors %}
                                    <div class="text-danger">{{ form.commission.errors }}</div>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="{{ form.products_sold.id_for_label }}" class="form-label-add-edit">Products Sold</label></th>
                            <td>
                                <input type="text" name="{{ form.products_sold.name }}" id="{{ form.products_sold.id_for_label }}" class="form-control" placeholder="Enter products sold" value="{{ form.products_sold.value|default_if_none:'' }}">
                                {% if form.products_sold.errors %}
                                    <div class="text-danger">{{ form.products_sold.errors }}</div>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="{{ form.phone_number.id_for_label }}" class="form-label-add-edit">Phone Number</label></th>
                            <td>
                                <input type="text" name="{{ form.phone_number.name }}" id="{{ form.phone_number.id_for_label }}" class="form-control" placeholder="Enter phone number" value="{{ form.phone_number.value|default_if_none:'' }}">
                                {% if form.phone_number.errors %}
                                    <div class="text-danger">{{ form.phone_number.errors }}</div>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="{{ form.notes.id_for_label }}" class="form-label-add-edit">Notes</label></th>
                            <td>
                                <textarea name="{{ form.notes.name }}" id="{{ form.notes.id_for_label }}" class="form-control" placeholder="Enter notes" rows="4">{{ form.notes.value|default_if_none:'' }}</textarea>
                                {% if form.notes.errors %}
                                    <div class="text-danger">{{ form.notes.errors }}</div>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="login-page">
                    <button type="submit">
                        <span class="text">{% if form.instance.pk %}Save Changes{% else %}Add Sale{% endif %}</span>
                    </button>
                    <button>
                        <span>
                            <a href="{% url 'sale_list' %}">Cancel</a>
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script async src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initAutocomplete"></script>   <!--Updated-->

<script>
    function initAutocomplete() {
        const input = document.getElementById('id_address');
        const latitudeInput = document.getElementById('id_latitude');
        const longitudeInput = document.getElementById('id_longitude');
        const autocomplete = new google.maps.places.Autocomplete(input, {
            types: ['address'],
            componentRestrictions: { country: 'us' }
        });
        autocomplete.setFields(['address_components', 'formatted_address', 'geometry']);
        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.address_components) {
                input.value = '';
                latitudeInput.value = '';
                longitudeInput.value = '';
                alert('Please select a valid address with city and zip code from the suggestions.');
                return;
            }
            // Ensure required components are present
            let hasStreet = false, hasCity = false, hasState = false, hasZip = false;
            for (const component of place.address_components) {
                if (component.types.includes('street_number') || component.types.includes('route')) {
                    hasStreet = true;
                } else if (component.types.includes('locality')) {
                    hasCity = true;
                } else if (component.types.includes('administrative_area_level_1')) {
                    hasState = true;
                } else if (component.types.includes('postal_code')) {
                    hasZip = true;
                }
            }
            if (!hasStreet || !hasCity || !hasState || !hasZip) {
                input.value = '';
                latitudeInput.value = '';
                longitudeInput.value = '';
                alert('Selected address is incomplete. Please choose an address with street, city, state, and zip code.');
            } else {
                input.value = place.formatted_address;
                latitudeInput.value = place.geometry.location.lat();
                longitudeInput.value = place.geometry.location.lng();
            }
        });
    }
    google.maps.event.addDomListener(window, 'load', initAutocomplete);

    // Prevent form submission if address is incomplete
    document.getElementById('saleForm').addEventListener('submit', function(event) {
        const addressInput = document.getElementById('id_address').value;
        const latitudeInput = document.getElementById('id_latitude').value;
        const longitudeInput = document.getElementById('id_longitude').value;
        if (!addressInput.includes(',') || !/\d{5}/.test(addressInput) || !latitudeInput || !longitudeInput) {
            event.preventDefault();
            alert('Please select a complete address with city and zip code from the suggestions.');
        }
    });

    // Real-time calculation of accountability_amount
    const amountInput = document.getElementById('id_amount');
    const splitInput = document.getElementById('id_sale_amount_split');
    const accountabilityInput = document.getElementById('id_accountability_amount');

    function updateAccountabilityAmount() {
        const amount = parseFloat(amountInput.value) || 0;
        const split = parseInt(splitInput.value) || 1;
        const accountability = split > 0 ? (amount / split).toFixed(2) : amount.toFixed(2);
        accountabilityInput.value = accountability;
    }

    amountInput.addEventListener('input', updateAccountabilityAmount);
    splitInput.addEventListener('input', updateAccountabilityAmount);
    updateAccountabilityAmount();
</script>
{% endblock %}